<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Sales Agent</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f9; display:flex; justify-content:center; padding:30px; }
    .container { width:420px; background:#fff; border-radius:16px; box-shadow:0 8px 25px rgba(0,0,0,0.1); overflow:hidden; display:flex; flex-direction:column; }
    .header { display:flex; justify-content:space-between; align-items:center; padding:14px 20px; background:#0b8456; color:#fff; font-weight:600; font-size:18px; }
    .badge { padding:6px 10px; border-radius:18px; font-weight:700; font-size:12px; }
    .stage-cold { background:#9aa6a0; }
    .stage-warm { background:#ffb347; color:#000; }
    .stage-hot  { background:#ff6b6b; }
    .stage-closed{ background:#4caf50; }
    .chat { flex:1; padding:16px; overflow:auto; background:#f9fafb; }
    .message { max-width:80%; margin:10px 0; padding:12px 14px; border-radius:14px; line-height:1.5; position: relative; animation: fadeIn 0.3s ease; white-space: pre-wrap; }
    .user { margin-left:auto; background:#0b8456; color:#fff; border-bottom-right-radius:4px; }
    .bot  { margin-right:auto; background:#e9ecef; color:#000; border-bottom-left-radius:4px; }
    .timestamp { font-size:10px; color:#555; position:absolute; bottom:-14px; right:6px; }
    .footer { display:flex; border-top:1px solid #eee; flex-wrap: wrap; gap: 6px; padding:10px; align-items:center; justify-content:space-between; }
    input { flex:1; padding:12px; border-radius:8px; border:1px solid #ccc; }
    button { background:#0b8456; color:#fff; border:none; padding:10px 14px; cursor:pointer; border-radius:8px; transition:0.2s; }
    button:hover { background:#096945; }
    button:disabled { background:#999; cursor:not-allowed; }
    .mic-controls { display:flex; gap:8px; }
    @keyframes fadeIn { from {opacity:0; transform:translateY(5px);} to {opacity:1; transform:translateY(0);} }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>AI Sales Agent</div>
      <div>
        <span id="leadBadge" class="badge stage-cold">Lead: Cold</span>
        <span id="emoLabel" style="font-size:12px; margin-left:8px;">Emotion: neutral</span>
      </div>
    </div>

    <div id="chat" class="chat"></div>

    <div class="footer">
      <input id="input" type="text" placeholder="Type a message..." />
      <button id="send">Send</button>
      <div class="mic-controls">
        <button id="micStart">ðŸŽ¤ Start</button>
        <button id="micStop" disabled>ðŸ›‘ Stop</button>
      </div>
    </div>
  </div>

  <script>
    const chatEl = document.getElementById('chat');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const micStartBtn = document.getElementById('micStart');
    const micStopBtn = document.getElementById('micStop');
    const leadBadge = document.getElementById('leadBadge');
    const emoLabel = document.getElementById('emoLabel');

    let sessionId = localStorage.getItem('sessionId');
    if (!sessionId) {
      sessionId = 'sess_' + Math.random().toString(36).slice(2,10);
      localStorage.setItem('sessionId', sessionId);
    }

    let recognition;

    function addMessage(who, text, timestamp=null) {
      const d = document.createElement('div');
      d.className = 'message ' + (who === 'user' ? 'user' : 'bot');
      
      // âœ… Just display plain text, even if backend sends "__TABLE__"
      d.textContent = text.replace("__TABLE__", "");
      
      if (timestamp) {
        const ts = document.createElement('div');
        ts.className = 'timestamp';
        ts.textContent = timestamp;
        d.appendChild(ts);
      }

      chatEl.appendChild(d);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function setLeadStage(stage) {
      leadBadge.textContent = 'Lead: ' + stage;
      leadBadge.className = 'badge ' +
        (stage === 'cold' ? 'stage-cold' : stage === 'warm' ? 'stage-warm' : stage === 'hot' ? 'stage-hot' : 'stage-closed');
    }

    function setEmotion(e) {
      emoLabel.textContent = 'Emotion: ' + e;
    }

    async function sendMessageFromUI(text) {
      if (!text) return;

      const currentTime = new Date().toLocaleString('en-GB', { timeZone: 'Asia/Karachi', hour12: true });
      addMessage('user', text, currentTime);

      const typingEl = document.createElement('div');
      typingEl.className = 'message bot';
      typingEl.textContent = 'Sales Agent is typing...';
      chatEl.appendChild(typingEl);
      chatEl.scrollTop = chatEl.scrollHeight;

      try {
        const res = await fetch("{% url 'chat_api' %}", {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ session_id: sessionId, message: text })
        });
        const data = await res.json();

        typingEl.remove();

        const botTime = new Date().toLocaleString('en-GB', { timeZone: 'Asia/Karachi', hour12: true });
        addMessage('bot', data.reply, botTime);

        setLeadStage(data.lead_stage || 'cold');
        setEmotion(data.emotion || 'neutral');

        const utterance = new SpeechSynthesisUtterance(data.reply.replace("__TABLE__", ""));
        utterance.lang = "en-US";
        speechSynthesis.speak(utterance);

      } catch (err) {
        console.error(err);
        typingEl.remove();
        addMessage('bot', 'Error contacting server.', new Date().toLocaleString('en-GB', { timeZone: 'Asia/Karachi', hour12: true }));
      }
    }

    sendBtn.addEventListener('click', () => {
      const val = inputEl.value.trim();
      sendMessageFromUI(val);
      inputEl.value = '';
    });

    inputEl.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendBtn.click();
    });

    micStartBtn.addEventListener('click', () => {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) { alert("Speech Recognition not supported"); return; }

      recognition = new SpeechRecognition();
      recognition.lang = "en-US";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.start();
      micStartBtn.disabled = true;
      micStopBtn.disabled = false;

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        sendMessageFromUI(transcript);
      };

      recognition.onerror = (event) => {
        addMessage('bot', 'ðŸŽ¤ Speech recognition error: ' + event.error, new Date().toLocaleString('en-GB', { timeZone: 'Asia/Karachi', hour12: true }));
        micStartBtn.disabled = false;
        micStopBtn.disabled = true;
      };

      recognition.onend = () => {
        micStartBtn.disabled = false;
        micStopBtn.disabled = true;
      };
    });

    micStopBtn.addEventListener('click', () => {
      if (recognition) recognition.stop();
    });

    window.addEventListener('load', async () => {
      try {
        const res = await fetch("{% url 'chat_api' %}", {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ session_id: sessionId, message: "" })
        });
        const data = await res.json();

        if (data.history && data.history.length) {
          data.history.forEach(msg => addMessage(msg.sender, msg.message, msg.time));
        }

        setLeadStage(data.lead_stage || 'cold');
        setEmotion(data.emotion || 'neutral');

        if (!data.history || !data.history.length) {
          addMessage('bot', "ðŸ¤– Welcome! I'm your AI sales assistant. Type or speak your question.", new Date().toLocaleString('en-GB', { timeZone: 'Asia/Karachi', hour12: true }));
        }

      } catch(err) {
        console.error("Error fetching history:", err);
      }
    });
  </script>
</body>
</html>
